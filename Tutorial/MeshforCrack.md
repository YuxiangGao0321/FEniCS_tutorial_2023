# Mesh generation for a domain with crack or notch
## Mesh size
The length scale $l_c$ can be derived from
$l_c \approx \frac{E G_{Ic}}{\sigma^2_c}=\frac{(1-\nu^2)K^2_{Ic}}{\sigma^2_c}$
where $G_{Ic}$ is critical strain energy release rate, $K_{Ic}$ is the critical stress intensity factor, and $\sigma_c$ is the critical stress.

The mesh size $l_m$ should be sufficiently smaller than the chosen length scale $l_c$. Usually we take $l_m < \frac{1}{8} l_c$
## mshr
mshr was included in FEniCS after 2016. 
### Documentation
There isn't good document for the Python APIs of mshr. Only some demo [here](https://bitbucket.org/fenics-project/mshr/src/master/demo/python/classic.py).
### Code for generate mesh for a square plate with notch
Import the packages

    from dolfin import *
    from fenics import *
    ### Generate the geometry and the mesh with mshr
    ### mshr was included in FEniCS after 2016
    from mshr import *
    from matplotlib import pyplot as plt

Define the notch size

    ### Define the notch size
    notch_length = 0.5
    notch_width = 0.02

Draw the domain by subtracting a notch from a square plate

    ### Draw the domain by
    ### Subtracting a notch from a square plate
    domain = Rectangle(Point(0.,0.),Point(1.,1.)) - \
    	Rectangle(Point(0.,0.5-notch_width/2),
    		Point(notch_length,0.5+notch_width/2))
Mesh generation

    ### Mesh the domain
    mesh = generate_mesh(domain, 60) # geometry and mesh resolution
For now, mshr only supports to generate uniform mesh.

Finally, plot the mesh with the FEniCS inbuilt function.

    plot(mesh, lw = 0.05)
    plt.savefig("mesh.jpg", dpi = 300)
![Mesh from mshr](https://github.com/YuxiangGao0321/FEniCS_tutorial_2023/blob/main/figs/mesh.jpg?raw=true)
## Gmsh
Gmsh is an open source 3D finite element mesh generator with a built-in CAD engine and post-processor.
### Install
See the tutorial [here](https://gmsh.info/#Download) for detail.

Download both Gmsh and the SDK with pip:

    pip install --upgrade gmsh
  
### Documentation
  [Gmsh reference manual (stable release)](https://gmsh.info/doc/texinfo/gmsh.html)  (also available in  [PDF](https://gmsh.info/doc/texinfo/gmsh.pdf)  and in  [plain text](https://gmsh.info/doc/texinfo/gmsh.txt))

### Code for generate mesh for a square plate with pre-existing double node crack
Please run the code in your local Python environment instead of docker. 

First, import the packages

    import gmsh
    import sys

Define some parameters

    L = 1
    notch_length = 0.5
    fine_mesh_area_width = 0.06
    mesh_size = 0.05
    eps = mesh_size*1e-5
Initialize Gmsh and add a new model

    gmsh.initialize()
    gmsh.model.add("Plate_with_notch")

To draw a plate with double node crack, we can first generate all the points, then connect them with lines and generate the surface with the line loop.

A point can be generate by [gmsh.model.occ.addPoint](https://gmsh.info/doc/texinfo/gmsh.html#Namespace-gmsh_002fmodel_002focc:~:text=gmsh/model/occ/addPoint)

    gmsh.model.occ.addPoint(x, y, z, tag = -1)

Two points can be connected with a line by [gmsh.model.occ.addLine](https://gmsh.info/doc/texinfo/gmsh.html#Namespace-gmsh_002fmodel_002focc:~:text=gmsh/model/occ/addLine)

    gmsh.model.occ.addLine(PointTag1, PointTag2, tag = -1)

The curve loop can be generated by [gmsh.model.occ.addCurveLoop](https://gmsh.info/doc/texinfo/gmsh.html#Namespace-gmsh_002fmodel_002focc:~:text=gmsh/model/occ/addCurveLoop)

    gmsh.model.occ.addCurveLoop([LineTagList], tag = -1)

The plane surface can be generated by a closed curve loop by [gmsh.model.occ.addPlaneSurface](https://gmsh.info/doc/texinfo/gmsh.html#Namespace-gmsh_002fmodel_002focc:~:text=gmsh/model/occ/addPlaneSurface)

    gmsh.model.occ.addPlaneSurface([CurveLoopTagList],tag = -1)

To prevent the numerical or precision issues, the two overlapping points on the crack should keep a very small distance. For example, 

    gmsh.model.occ.addPoint(x, y-eps, z, tag = -1)
    gmsh.model.occ.addPoint(x, y+eps, z, tag = -1)


Before meshing the domain, synchronize CAD representation with current model and add the model to a physical group.

    gmsh.model.occ.synchronize()
    gmsh.model.addPhysicalGroup(dim, [tag])
 
 Then, define the mesh size field for the domain. Here we use the "Box" method. We can define the mesh size in the box and out of the box.

    gmsh.model.mesh.field.add("Box", tag)
    gmsh.model.mesh.field.setNumber(tag, "VIn", mesh_size_in)
    gmsh.model.mesh.field.setNumber(tag, "VOut", mesh_size_out)
    gmsh.model.mesh.field.setNumber(tag, "XMin", x_min-eps)
    gmsh.model.mesh.field.setNumber(tag, "XMax", x_max+eps)
    gmsh.model.mesh.field.setNumber(tag, "YMin", y_min-eps)
    gmsh.model.mesh.field.setNumber(tag, "YMax", y_max+eps)
    gmsh.model.mesh.field.setAsBackgroundMesh(tag)

Generate the mesh over the domain. Some mesh algorithms can be specified by 

    gmsh.option.setNumber("Mesh.Algorithm", 1)
    gmsh.option.setNumber("Mesh.RecombinationAlgorithm", 2)
    gmsh.model.mesh.generate(2)
Here are the details for [Mesh.Algorithm](http://gmsh.info/doc/texinfo/gmsh.html#Specifying-mesh-element-sizes:~:text=7.4-,Mesh%20options,-Mesh.Algorithm) and [Mesh.RecombinationAlgorithm](http://gmsh.info/doc/texinfo/gmsh.html#Specifying-mesh-element-sizes:~:text=Mesh%20recombination%20algorithm)

The following command can open a Gmsh GUI to show your current geometry or mesh. You can insert it anywhere.

    gmsh.model.occ.synchronize()
    if '-nopopup' not in sys.argv:
    	gmsh.fltk.run()
The mesh can be saved by

    gmsh.write(file_name)

Finally, finalize Gmsh by

    gmsh.finalize()

If we want to generate a plate with notch instead, we can first draw two rectangle surfaces by [gmsh.model.occ.addRectangle](https://gmsh.info/doc/texinfo/gmsh.html#Namespace-gmsh_002fmodel_002fmesh:~:text=gmsh/model/occ/addRectangle) with different tags (positive valves).

    gmsh.model.occ.addRectangle(x,y,z,dx,dy,tag = -1)

Secondly, subtract the notch from the plate by [gmsh.model.occ.cut](https://gmsh.info/doc/texinfo/gmsh.html#Namespace-gmsh_002fmodel_002fmesh:~:text=gmsh/model/occ/cut)

    gmsh.model.occ.cut([objectDimTags], [toolDimTags], tag = -1)

The object and the tool should be referred by a vector of pairs of integers

    (dimension of the entity, tag)

### Import the mesh to FEniCS

Before importing the mesh into FEniCS, the mesh information should be saved in a .dat file. Then, use the [code](https://github.com/YuxiangGao0321/FEniCS_tutorial_2023/blob/main/Gmsh2xml.py) I posted to convert the mesh information to a .xml file with a readable format for FEniCS. Then the mesh can be import to FEniCS by

    mesh = Mesh("mesh.xml")

![Mesh from Gmsh](https://github.com/YuxiangGao0321/FEniCS_tutorial_2023/blob/main/figs/mesh_Gmsh.jpg?raw=true)
